#!/usr/bin/env sh
# VDE Error Messages Library
# Provides contextual error messages with remediation steps
# Source this library with: source ./scripts/lib/vde-errors
#
# Features:
# - Error message catalog with common errors and solutions
# - Enhanced error functions with remediation steps
# - Documentation link integration
# - Verbose mode support for detailed error output
#
# Shell Compatibility: POSIX-compliant (sh, bash, zsh)
#
# Usage:
#   source ./scripts/lib/vde-errors
#   
#   # Basic error with solution:
#   vde_error_docker_not_running
#   
#   # Custom error with remediation:
#   vde_error_show "Something went wrong" "Because of X" "Do Y to fix"
#   
#   # Check verbose mode:
#   if vde_error_is_verbose; then
#       echo "Detailed debug info"
#   fi

# =============================================================================
# SOURCE GUARD
# =============================================================================

if [ "${_VDE_ERRORS_LOADED:-}" = "1" ]; then
    return 0 2>/dev/null || exit 0
fi
_VDE_ERRORS_LOADED=1

# =============================================================================
# CONFIGURATION
# =============================================================================

# Verbose mode - set to 1 for detailed error output
VDE_ERRORS_VERBOSE="${VDE_ERRORS_VERBOSE:-0}"
export VDE_ERRORS_VERBOSE

# Documentation base URL
VDE_ERRORS_DOC_URL="${VDE_ERRORS_DOC_URL:-https://github.com/dderyldowney/dev/blob/main/docs}"

# Show remediation steps by default
VDE_ERRORS_SHOW_SOLUTION="${VDE_ERRORS_SHOW_SOLUTION:-1}"

# =============================================================================
# COLOR SUPPORT
# =============================================================================

_vde_errors_has_colors() {
    if [ -t 2 ]; then
        return 0
    fi
    if [ -n "${TERM:-}" ] && [ "${TERM:-}" != "dumb" ]; then
        return 0
    fi
    return 1
}

if _vde_errors_has_colors; then
    VDE_ERRORS_COLOR_RESET='\033[0m'
    VDE_ERRORS_COLOR_ERROR='\033[1;31m'    # Red
    VDE_ERRORS_COLOR_WARNING='\033[1;33m'   # Yellow
    VDE_ERRORS_COLOR_INFO='\033[1;34m'      # Blue
    VDE_ERRORS_COLOR_SUCCESS='\033[1;32m'   # Green
    VDE_ERRORS_COLOR_DIM='\033[2m'          # Dim
    VDE_ERRORS_COLOR_LINK='\033[4;36m'      # Underline cyan
else
    VDE_ERRORS_COLOR_RESET=''
    VDE_ERRORS_COLOR_ERROR=''
    VDE_ERRORS_COLOR_WARNING=''
    VDE_ERRORS_COLOR_INFO=''
    VDE_ERRORS_COLOR_SUCCESS=''
    VDE_ERRORS_COLOR_DIM=''
    VDE_ERRORS_COLOR_LINK=''
fi

# =============================================================================
# VERBOSE MODE UTILITIES
# =============================================================================

# vde_error_set_verbose - Enable/disable verbose mode
vde_error_set_verbose() {
    VDE_ERRORS_VERBOSE="${1:-1}"
}

# vde_error_is_verbose - Check if verbose mode is enabled
vde_error_is_verbose() {
    [ "$VDE_ERRORS_VERBOSE" = "1" ]
}

# =============================================================================
# FORMATTING FUNCTIONS
# =============================================================================

_vde_error_format_block() {
    local text="$1"
    local indent="${2:-4}"
    printf '%s' "$text" | while IFS= read -r line; do
        printf "%${indent}s%s\n" "" "$line"
    done
}

# =============================================================================
# CORE ERROR FUNCTIONS
# =============================================================================

# vde_error_show - Show a full error message with what, why, and how
# Args: <what> <why> <how> [doc_link]
vde_error_show() {
    local what="$1"
    local why="$2"
    local how="$3"
    local doc_link="${4:-}"
    
    printf "%s%s\n" "${VDE_ERRORS_COLOR_ERROR}Error:${VDE_ERRORS_COLOR_RESET} " "$what"
    
    if [ -n "$why" ]; then
        printf "%s%s\n" "${VDE_ERRORS_COLOR_DIM}Reason:${VDE_ERRORS_COLOR_RESET} " "$why"
    fi
    
    if [ "$VDE_ERRORS_SHOW_SOLUTION" = "1" ] && [ -n "$how" ]; then
        printf "%s\n" "${VDE_ERRORS_COLOR_WARNING}Solution:${VDE_ERRORS_COLOR_RESET}"
        _vde_error_format_block "$how" | sed "s/^/${VDE_ERRORS_COLOR_INFO}/;s/$/${VDE_ERRORS_COLOR_RESET}/"
    fi
    
    if [ -n "$doc_link" ]; then
        local full_url="${VDE_ERRORS_DOC_URL}/${doc_link}"
        printf "%s%s\n" "${VDE_ERRORS_COLOR_LINK}Docs:${VDE_ERRORS_COLOR_RESET} " "$full_url"
    fi
    
    printf '\n'
}

# vde_error_simple - Show a simple error message
vde_error_simple() {
    local message="$1"
    printf "%s%s\n" "${VDE_ERRORS_COLOR_ERROR}Error:${VDE_ERRORS_COLOR_RESET} " "$message"
}

# vde_error_with_code - Show error with exit code
vde_error_with_code() {
    local message="$1"
    local exit_code="$2"
    printf "%s%s (exit code: %d)\n" "${VDE_ERRORS_COLOR_ERROR}Error:${VDE_ERRORS_COLOR_RESET} " "$message" "$exit_code"
}

# =============================================================================
# COMMON ERROR SCENARIOS
# =============================================================================

vde_error_docker_not_running() {
    vde_error_show \
        "Cannot connect to Docker daemon" \
        "Docker daemon is not running or you don't have permission to access it" \
        "1. Start Docker: sudo systemctl start docker (Linux) or start Docker Desktop (macOS/Windows)
2. Add your user to the docker group: sudo usermod -aG docker \$USER
3. Log out and back in for group changes to take effect" \
        "troubleshooting.md#docker-daemon-not-running"
}

vde_error_port_in_use() {
    local port="$1"
    vde_error_show \
        "Port $port is already in use" \
        "Another process or container is using the required SSH port" \
        "1. Check what's using the port: lsof -i :$port or netstat -tlnp | grep $port
2. Stop the conflicting process, or
3. Choose a different VM name to get an automatic port assignment" \
        "troubleshooting.md#port-conflicts"
}

vde_error_ssh_key_missing() {
    vde_error_show \
        "No SSH key found" \
        "VDE requires SSH keys for container authentication" \
        "1. Generate a new SSH key: ssh-keygen -t ed25519 -C \"your@email.com\"
2. Or specify an existing key path when prompted" \
        "ssh-configuration.md#generating-ssh-keys"
}

vde_error_container_exists() {
    local name="$1"
    vde_error_show \
        "VM '$name' already exists" \
        "A VM with this name has already been created" \
        "1. List existing VMs: vde list-vms
2. Start the existing VM: vde start-virtual $name
3. Or delete the existing VM: vde delete-virtual $name" \
        "command-reference.md#list-vms"
}

vde_error_permission_denied() {
    local path="$1"
    vde_error_show \
        "Permission denied: $path" \
        "You don't have the required permissions to access this resource" \
        "1. Check file permissions: ls -la $path
2. Fix ownership: sudo chown -R \$(whoami):\$(whoami) $path
3. Or run with appropriate permissions" \
        "troubleshooting.md#permission-issues"
}

vde_error_vm_not_found() {
    local name="$1"
    vde_error_show \
        "VM '$name' not found" \
        "No VM with this name exists in your configuration" \
        "1. List available VMs: vde list-vms
2. See available types: vde show-vm-types
3. Create a new VM: vde create-virtual-for <type>" \
        "command-reference.md#create-virtual-for"
}

vde_error_vm_not_running() {
    local name="$1"
    vde_error_show \
        "VM '$name' is not running" \
        "The VM exists but is currently stopped" \
        "1. Start the VM: vde start-virtual $name
2. Check VM status: vde status" \
        "command-reference.md#start-virtual"
}

vde_error_docker_build_failed() {
    local vm="$1"
    vde_error_show \
        "Docker build failed for '$vm'" \
        "The container image could not be built" \
        "1. Check Docker logs: vde logs $vm
2. Verify Docker is running: docker ps
3. Try rebuilding with cache: vde start-virtual $vm" \
        "troubleshooting.md#docker-build-issues"
}

vde_error_network_not_found() {
    local network="$1"
    vde_error_show \
        "Docker network '$network' not found" \
        "The required Docker network doesn't exist" \
        "1. Create the network: docker network create $network
2. Or run VDE setup: vde setup" \
        "troubleshooting.md#docker-network"
}

vde_error_template_not_found() {
    local template="$1"
    vde_error_show \
        "Template not found: $template" \
        "The required template file is missing or has been moved" \
        "1. Check template directory: ls \$VDE_ROOT_DIR/scripts/templates/
2. Verify installation: vde doctor
3. Reinstall VDE if templates are missing" \
        "extending-vde.md#templates"
}

vde_error_invalid_vm_name() {
    local name="$1"
    vde_error_show \
        "Invalid VM name: '$name'" \
        "VM names must follow the naming convention" \
        "1. Language VMs should use format: <name>-dev (e.g., python-dev, rust-dev)
2. Service VMs should use format: <name> (e.g., postgres, redis)
3. Only lowercase alphanumeric characters are allowed" \
        "predefined-vm-types.md#naming-convention"
}

vde_error_alias_not_found() {
    local alias="$1"
    vde_error_show \
        "Unknown VM type or alias: '$alias'" \
        "This VM type or alias is not configured" \
        "1. List known types: vde show-vm-types
2. Add custom types in: \$VDE_ROOT_DIR/scripts/data/vm-types.conf
3. Use the full VM name instead of alias" \
        "predefined-vm-types.md"
}

# =============================================================================
# SUCCESS MESSAGES
# =============================================================================

vde_success() {
    local message="$1"
    printf "%s%s\n" "${VDE_ERRORS_COLOR_SUCCESS}âœ“${VDE_ERRORS_COLOR_RESET} " "$message"
}

# Note: log_error and log_success are provided by vm-common
# These wrappers are for backward compatibility if vm-common is not sourced
if ! command -v log_error >/dev/null 2>&1; then
    log_error() {
        vde_error_simple "$@"
    }
fi

if ! command -v log_success >/dev/null 2>&1; then
    log_success() {
        vde_success "$@"
    }
fi
