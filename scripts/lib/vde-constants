#!/bin/zsh
# VDE Constants Library
# Centralized constants for the Virtual Development Environment
# Source this library with: source ./scripts/lib/vde-constants
#
# This file contains all magic numbers, configuration values, and constants
# used throughout the VDE system. Centralizing these values improves:
# - Maintainability: Change values in one place
# - Documentation: Each constant is explained
# - Consistency: All scripts use the same values
#
# Shell Compatibility: This file uses POSIX-compatible syntax for portability
# across zsh 5.0+, bash 4.0+, and bash 3.x (with limitations)

# =============================================================================
# SOURCE GUARD
# =============================================================================
# Prevent multiple sourcing which causes readonly variable errors

if [ "${_VDE_CONSTANTS_LOADED:-}" = "1" ]; then
    return 0 2>/dev/null || exit 0
fi
_VDE_CONSTANTS_LOADED=1

# =============================================================================
# STANDARD RETURN CODES
# =============================================================================
# All VDE functions should use these standardized return codes for consistency.
# This enables proper error handling and debugging across the system.

# Success - Operation completed successfully
VDE_SUCCESS=0
readonly VDE_SUCCESS

# General error - Unspecified failure
readonly VDE_ERR_GENERAL=1

# Invalid input - Bad arguments, malformed input, validation failure
readonly VDE_ERR_INVALID_INPUT=2

# Resource not found - File, VM, container, or other resource doesn't exist
readonly VDE_ERR_NOT_FOUND=3

# Permission denied - Insufficient permissions for operation
readonly VDE_ERR_PERMISSION=4

# Timeout - Operation exceeded time limit
readonly VDE_ERR_TIMEOUT=5

# Already exists - Resource already exists when trying to create
readonly VDE_ERR_EXISTS=6

# Dependency error - Required dependency missing or failed
readonly VDE_ERR_DEPENDENCY=7

# Docker error - Docker-specific operation failure
readonly VDE_ERR_DOCKER=8

# Lock error - Failed to acquire lock for atomic operation
readonly VDE_ERR_LOCK=9

# =============================================================================
# PORT CONFIGURATION
# =============================================================================
# VDE uses specific port ranges to avoid conflicts with common services.
# Language VMs and Service VMs have separate ranges for easy identification.

# Language VM SSH Port Range (2200-2299)
# These ports are used for SSH access to language development containers
# (Python, Ruby, Rust, Go, JavaScript, etc.)
# Range provides capacity for up to 100 language VMs
readonly VDE_LANG_PORT_START=2200
readonly VDE_LANG_PORT_END=2299

# Service VM SSH Port Range (2400-2499)
# These ports are used for SSH access to service containers
# (PostgreSQL, Redis, MongoDB, Nginx, etc.)
# Range provides capacity for up to 100 service VMs
readonly VDE_SVC_PORT_START=2400
readonly VDE_SVC_PORT_END=2499

# Default SSH port inside containers
# All VDE containers expose SSH on port 22 internally
readonly VDE_CONTAINER_SSH_PORT=22

# =============================================================================
# TIMEOUT CONFIGURATION
# =============================================================================
# Timeouts for various operations to prevent hanging and enable proper cleanup

# Docker operation timeout (seconds)
# Maximum time to wait for docker-compose up/down operations
readonly VDE_DOCKER_TIMEOUT=600

# SSH connection timeout (seconds)
# Maximum time to wait for SSH connection to container
readonly VDE_SSH_TIMEOUT=60

# Lock acquisition timeout (seconds)
# Maximum time to wait when acquiring file locks
readonly VDE_LOCK_TIMEOUT=30

# Health check timeout (seconds)
# Maximum time to wait for container health check
readonly VDE_HEALTH_TIMEOUT=180

# Container startup wait (seconds)
# Time to wait after container starts before checking health
readonly VDE_STARTUP_WAIT=15

# =============================================================================
# RETRY CONFIGURATION
# =============================================================================
# Retry settings for transient failures (network issues, resource contention)

# Maximum retry attempts for docker operations
readonly VDE_MAX_RETRIES=3

# Base delay for exponential backoff (seconds)
# Actual delay = VDE_RETRY_BASE_DELAY * (2 ^ attempt)
readonly VDE_RETRY_BASE_DELAY=2

# Maximum delay between retries (seconds)
# Caps the exponential backoff to prevent excessive waits
readonly VDE_RETRY_MAX_DELAY=30

# =============================================================================
# LOCK CONFIGURATION
# =============================================================================
# Settings for file-based locking to prevent race conditions

# Stale lock threshold (seconds)
# Locks older than this are considered stale and can be cleaned up
# Reduced from 300s to 30s because we also check PID liveness
readonly VDE_STALE_LOCK_AGE=30

# Lock check interval base (seconds)
# Base interval for checking lock availability
readonly VDE_LOCK_CHECK_INTERVAL=0.1

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================
# Settings for VDE logging system

# Log retention (days)
# How long to keep log files before rotation/cleanup
readonly VDE_LOG_RETENTION_DAYS=30

# Maximum log file size (bytes)
# Logs larger than this will be rotated
readonly VDE_MAX_LOG_SIZE=10485760  # 10MB

# =============================================================================
# DOCKER CONFIGURATION
# =============================================================================
# Docker-specific settings and defaults

# Default Docker network name for VDE containers
readonly VDE_DOCKER_NETWORK="vde-network"

# Docker compose project name prefix
readonly VDE_COMPOSE_PROJECT_PREFIX="vde"

# Container naming patterns
readonly VDE_LANG_CONTAINER_SUFFIX="-dev"
readonly VDE_SVC_CONTAINER_SUFFIX=""

# =============================================================================
# SSH CONFIGURATION
# =============================================================================
# SSH-related constants

# Default SSH user for VDE containers
readonly VDE_SSH_USER="dev"

# SSH key types in order of preference (most secure first)
# Note: Array syntax is compatible with both bash and zsh
VDE_SSH_KEY_PREFERENCE="id_ed25519 id_ecdsa id_rsa id_dsa"
readonly VDE_SSH_KEY_PREFERENCE

# =============================================================================
# VDE SSH ISOLATION
# =============================================================================
# VDE uses an isolated SSH directory to prevent interference with user's
# personal SSH configuration. All VDE SSH files are stored under ~/.ssh/vde/

# VDE SSH directory (isolated from user's SSH)
readonly VDE_SSH_DIR="$HOME/.ssh/vde"

# VDE SSH config file (contains only VDE VM entries)
readonly VDE_SSH_CONFIG="$VDE_SSH_DIR/config"

# VDE SSH known_hosts file (contains only VDE VM host keys)
readonly VDE_SSH_KNOWN_HOSTS="$VDE_SSH_DIR/known_hosts"

# VDE SSH identity key (auto-generated, VDE-specific)
readonly VDE_SSH_IDENTITY="$VDE_SSH_DIR/id_ed25519"

# VDE SSH public key
readonly VDE_SSH_IDENTITY_PUB="$VDE_SSH_DIR/id_ed25519.pub"

# =============================================================================
# FILE PATTERNS
# =============================================================================
# Regular expressions and glob patterns used throughout VDE

# Valid VM name pattern (lowercase alphanumeric only)
readonly VDE_VM_NAME_PATTERN='^[a-z0-9]+$'

# SSH port mapping pattern in docker-compose files
readonly VDE_SSH_PORT_PATTERN='[0-9]+:22'

# =============================================================================
# ERROR MESSAGES
# =============================================================================
# Standardized error message templates for consistent user feedback

readonly VDE_MSG_VM_NOT_FOUND="VM '%s' not found. Use 'vde list' to see available VMs."
readonly VDE_MSG_VM_EXISTS="VM '%s' already exists."
readonly VDE_MSG_INVALID_NAME="Invalid VM name '%s'. Names must be lowercase alphanumeric."
readonly VDE_MSG_DOCKER_FAILED="Docker operation failed for '%s'. Check docker logs for details."
readonly VDE_MSG_TIMEOUT="Operation timed out after %d seconds."
readonly VDE_MSG_LOCK_FAILED="Failed to acquire lock for '%s'. Another operation may be in progress."
readonly VDE_MSG_NO_SSH_KEY="No SSH key found. Generate one with: ssh-keygen -t ed25519"
