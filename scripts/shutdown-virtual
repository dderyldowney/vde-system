#!/usr/bin/env zsh
set -e

# Source shared library
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$SCRIPT_DIR/lib/vm-common"

# Parse arguments
if [[ $# -eq 0 ]]; then
    echo "Usage: $0 <vm_name1> [vm_name2] ... [all]"
    echo ""
    echo "Examples:"
    echo "  $0 python                    # Stop single VM"
    echo "  $0 python ruby js            # Stop multiple VMs"
    echo "  $0 all                       # Stop all VMs"
    echo ""
    show_known_vms
    exit 1
fi

# _vm_has_compose_file - Check if VM has a docker-compose.yml file
_vm_has_compose_file() {
    local vm="$1"
    local compose_file
    compose_file=$(get_compose_file "$vm" 2>/dev/null) || return 1
    [[ -f "$compose_file" ]]
}

# Parse VMs
VMS=()

for arg in "$@"; do
    case $arg in
        all)
            # Expand "all" to VMs that actually have compose files
            for vm in $(get_all_vms); do
                if _vm_has_compose_file "$vm"; then
                    VMS+=("$vm")
                fi
            done
            ;;
        *)
            # Check if it's a known VM or VM type
            local resolved
            resolved=$(resolve_vm_name "$arg" 2>/dev/null) || true
            if [[ -n "$resolved" ]]; then
                # Only add if it has a compose file
                if _vm_has_compose_file "$resolved"; then
                    VMS+=("$resolved")
                else
                    log_warning "VM '$arg' not created (no compose file)"
                fi
            else
                log_error "Unknown VM: $arg"
                exit 1
            fi
            ;;
    esac
done

# If no VMs specified, show usage
if [[ ${#VMS[@]} -eq 0 ]]; then
    echo "Usage: $0 <vm_name1> [vm_name2] ... [all]"
    echo ""
    echo "No VMs to stop. Create VMs first with: create-virtual-for <type>"
    echo ""
    show_known_vms
    exit 1
fi

# Stop VMs
log_info "Shutting down ${#VMS[@]} VM(s)..."
for vm in "${VMS[@]}"; do
    stop_vm "$vm"
done

log_success "VM shutdown complete!"
