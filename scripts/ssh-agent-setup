#!/usr/bin/env zsh
# VDE SSH Agent Setup
# Automatically sets up SSH keys, agent, and configuration

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$SCRIPT_DIR/lib/vm-common"

# Parse command line arguments
ACTION="status"
FORCE_GENERATE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --init|-i)
            ACTION="init"
            shift
            ;;
        --start|-s)
            ACTION="start"
            shift
            ;;
        --generate|-g)
            FORCE_GENERATE=true
            shift
            ;;
        --help|-h)
            echo "VDE SSH Agent Setup"
            echo ""
            echo "Usage: $0 [ACTION]"
            echo ""
            echo "Actions:"
            echo "  (default)  Show SSH status (no changes)"
            echo "  --init     Initialize SSH environment (keys, agent, config)"
            echo "  --start    Start SSH agent and load keys"
            echo "  --generate Force generate new SSH key"
            echo "  --help     Show this help"
            echo ""
            echo "Examples:"
            echo "  $0              # Show status only"
            echo "  $0 --init       # Full setup: keys + agent + config"
            echo "  $0 --start      # Start agent and load keys"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# ==============================================================================
# Status Display Mode (default)
# ==============================================================================
if [[ "$ACTION" == "status" ]]; then
    echo ""
    echo "╔════════════════════════════════════════════════════════════╗"
    echo "║          VDE SSH Agent Status                            ║"
    echo "╚════════════════════════════════════════════════════════════╝"
    echo ""

    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "Current Status"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""

    # VDE SSH Isolation info
    echo "VDE SSH Isolation:"
    echo "  Directory: $VDE_SSH_DIR"
    if [[ -f "$VDE_SSH_IDENTITY" ]]; then
        echo "  ✓ VDE SSH key exists"
    else
        echo "  ⚠ VDE SSH key not found (run --init)"
    fi
    if [[ -f "$VDE_SSH_CONFIG" ]]; then
        local vm_count
        vm_count=$(grep -c "^Host " "$VDE_SSH_CONFIG" 2>/dev/null || echo "0")
        echo "  ✓ VDE SSH config exists ($vm_count VM entries)"
    else
        echo "  ⚠ VDE SSH config not found"
    fi

    echo ""

    # SSH Agent Status
    if ssh_agent_is_running; then
        log_success "SSH agent is running"
        echo "  Socket: $SSH_AUTH_SOCK"
        echo "  PID: ${SSH_AGENT_PID:-unknown}"
    else
        log_warning "SSH agent is NOT running"
        echo "  Run: $0 --init  to set up SSH environment"
    fi

    echo ""

    # Keys loaded in agent
    if ssh_agent_is_running; then
        echo "Keys loaded in agent:"
        local key_count
        key_count=$(ssh-add -l 2>/dev/null | wc -l | tr -d ' ')
        if [[ $key_count -gt 0 ]]; then
            ssh-add -l 2>/dev/null
        else
            echo "  (none loaded)"
            echo "  Run: $0 --start  to load VDE key into agent"
        fi
    else
        echo "Keys in agent: (agent not running)"
    fi

    echo ""

    # Public keys in build context
    echo "Public key in build context:"
    if [[ -f "$VDE_ROOT_DIR/public-ssh-keys/vde_id_ed25519.pub" ]]; then
        echo "  ✓ vde_id_ed25519.pub"
    else
        echo "  (none - run --init to sync)"
    fi

    echo ""
    exit 0
fi

# ==============================================================================
# Initialize Mode -- Full SSH setup
# ==============================================================================
if [[ "$ACTION" == "init" ]]; then
    echo ""
    echo "╔════════════════════════════════════════════════════════════╗"
    echo "║          VDE SSH Agent Initialization                    ║"
    echo "╚════════════════════════════════════════════════════════════╝"
    echo ""

    # Step 1: Ensure VDE SSH environment
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "Step 1: Setting up VDE SSH environment"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""

    if ensure_vde_ssh_environment; then
        log_success "✓ VDE SSH directory: $VDE_SSH_DIR"
        log_success "✓ VDE SSH key: $VDE_SSH_IDENTITY"
    else
        log_error "✗ Failed to set up VDE SSH environment"
        exit 1
    fi

    echo ""

    # Step 2: Start SSH agent
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "Step 2: Starting SSH agent"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""

    if ssh_agent_is_running; then
        log_info "SSH agent already running"
    else
        log_info "Starting SSH agent..."
        eval "$(ssh-agent -s)" >/dev/null 2>&1
        export SSH_AUTH_SOCK
        export SSH_AGENT_PID
        log_success "✓ SSH agent started (PID: $SSH_AGENT_PID)"
    fi

    echo ""

    # Step 3: Load VDE key into agent
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "Step 3: Loading VDE key into SSH agent"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""

    local keys_loaded=0
    if ssh-add "$VDE_SSH_IDENTITY" 2>/dev/null; then
        log_success "✓ Loaded: VDE SSH key"
        keys_loaded=1
    else
        log_warning "⚠ Could not load VDE key (may require passphrase)"
        echo "  Load manually with: ssh-add $VDE_SSH_IDENTITY"
    fi

    if [[ $keys_loaded -gt 0 ]]; then
        log_success "✓ VDE key loaded into agent"
    else
        log_warning "⚠ No keys were loaded"
    fi

    echo ""

    # Step 4: Sync VDE public key to build context
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "Step 4: Syncing VDE public key to build context"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""

    if sync_ssh_keys_to_vde; then
        log_success "✓ VDE public key synced to public-ssh-keys/"
    else
        log_error "✗ Failed to sync key"
        exit 1
    fi

    echo ""

    # Step 5: Generate SSH config
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "Step 5: Generating VDE SSH config"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""

    if generate_vm_ssh_config; then
        log_success "✓ VDE SSH config updated"
    else
        log_warning "⚠ VDE SSH config generation had issues"
    fi

    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "Setup Complete!"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "VDE SSH is now isolated at: ~/.ssh/vde/"
    echo ""
    echo "Next steps:"
    echo "  • Create a VM: ./scripts/create-virtual-for python"
    echo "  • Start a VM:  ./scripts/start-virtual python"
    echo "  • Connect:      ssh -F ~/.ssh/vde/config python-dev"
    echo "                  Or use: vde_ssh python-dev"
    echo ""

    exit 0
fi

# ==============================================================================
# Start Mode -- Just start agent and load VDE key
# ==============================================================================
if [[ "$ACTION" == "start" ]]; then
    echo ""
    echo "Starting SSH agent and loading VDE key..."
    echo ""

    # Start agent if not running
    if ssh_agent_is_running; then
        echo "SSH agent already running"
    else
        eval "$(ssh-agent -s)" >/dev/null 2>&1
        export SSH_AUTH_SOCK
        export SSH_AGENT_PID
        echo "✓ SSH agent started"
    fi

    # Ensure VDE SSH environment exists
    if [[ ! -f "$VDE_SSH_IDENTITY" ]]; then
        echo "⚠ VDE SSH key not found. Run: $0 --init"
        exit 1
    fi

    # Load VDE key
    local keys_loaded=0
    if ssh-add "$VDE_SSH_IDENTITY" 2>/dev/null; then
        echo "✓ Loaded: VDE SSH key"
        keys_loaded=1
    fi

    echo ""
    echo "$keys_loaded key(s) loaded into SSH agent"
    exit 0
fi
