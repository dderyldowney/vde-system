#!/usr/bin/env zsh
# VDE SSH Agent Status & Configuration
# Shows SSH agent status and helps with manual configuration if needed

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$SCRIPT_DIR/lib/vm-common"

echo ""
echo "╔════════════════════════════════════════════════════════════╗"
echo "║          VDE SSH Agent Status                            ║"
echo "╚════════════════════════════════════════════════════════════╝"
echo ""

# Check current status
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Current Status"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# SSH Agent Status
if ssh_agent_is_running; then
    log_success "SSH agent is running"
    echo "  Socket: $SSH_AUTH_SOCK"
    echo "  PID: ${SSH_AGENT_PID:-unknown}"
else
    log_warning "SSH agent is not running"
    echo "  → Will be started automatically when you create/start VMs"
fi

echo ""

# Available SSH Keys
echo "Available SSH keys:"
local -a keys
keys=("${(@f)$(detect_ssh_keys)}")

if [[ ${#keys[@]} -eq 0 ]]; then
    echo "  (none found - will be auto-generated when needed)"
elif [[ ${#keys[@]} -eq 1 ]]; then
    echo "  ✓ ${keys[1]}"
else
    for key in "${keys[@]}"; do
        echo "  ✓ $key"
    done
fi

echo ""

# Keys loaded in agent
if ssh_agent_is_running; then
    echo "Keys loaded in agent:"
    local key_count
    key_count=$(ssh-add -l 2>/dev/null | wc -l)
    if [[ $key_count -gt 0 ]]; then
        ssh-add -l 2>/dev/null
    else
        echo "  (none loaded - will be auto-loaded when starting VMs)"
    fi
else
    echo "Keys in agent: (agent not running)"
fi

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "VDE Automation"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "VDE automatically handles SSH setup for you:"
echo ""
echo "✓ When creating VMs:"
echo "  • Generates SSH key if you don't have one"
echo "  • Starts SSH agent if not running"
echo "  • Adds your keys to the agent"
echo "  • Creates VM-to-VM SSH config entries"
echo ""
echo "✓ When starting VMs:"
echo "  • Ensures SSH agent is running"
echo "  • Verifies keys are loaded"
echo "  • Enables VM-to-VM communication"
echo ""
echo "✓ No manual setup required!"
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Usage Examples"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "From host:"
echo "  ./scripts/create-virtual-for go    # SSH setup happens automatically"
echo "  ./scripts/start-virtual go        # Agent enabled automatically"
echo "  ssh go-dev                       # Connect to Go VM"
echo ""
echo "From within a VM:"
echo "  ssh python-dev                   # VM → VM (uses your host keys!)"
echo "  git clone github.com:user/repo    # External Git operations"
echo "  to-host ls ~/dev                 # Execute command on host"
echo ""
echo "VM → VM Examples:"
echo "  # From python-dev:"
echo "  ssh rust-dev pwd                 # Check rust-dev directory"
echo "  scp rust-dev:/data/file .        # Copy file from rust VM"
echo "  rsync -av rust-dev:/data ./       # Sync directory from rust VM"
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Manual Operations (Optional)"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "Add a new key to agent:"
echo "  ssh-add ~/.ssh/new_key"
echo ""
echo "View loaded keys:"
echo "  ssh-add -l"
echo ""
echo "Stop agent:"
echo "  ssh-agent -k"
echo ""
echo "Restart agent:"
echo "  eval \$(ssh-agent -s) && ssh-add"
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Important Notes"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "• Your SSH keys NEVER leave the host machine"
echo "• Containers access keys via SSH agent socket forwarding"
echo "• All VMs can communicate with each other using your host keys"
echo "• Restarting VMs does NOT require re-configuration"
echo "• Everything is automated - no manual setup required!"
echo ""

# Check if rebuild is needed
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Existing VMs"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

local -a existing_vms
existing_vms=("${(@f)$(get_running_vms)}")

if [[ ${#existing_vms[@]} -gt 0 ]]; then
    log_info "Running VMs (${#existing_vms[@]}):"
    for vm in "${existing_vms[@]}"; do
        echo "  • $vm"
    done
    echo ""
    echo "Note: Existing VMs need rebuild for SSH agent support:"
    echo "  ./scripts/shutdown-virtual <vm>"
    echo "  ./scripts/start-virtual <vm> --rebuild"
else
    echo "No VMs currently running"
    echo ""
    echo "Create your first VM:"
    echo "  ./scripts/create-virtual-for python"
    echo "  ./scripts/start-virtual python"
fi

echo ""
