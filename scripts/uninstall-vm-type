#!/usr/bin/env zsh
#===============================================================================
# uninstall-vm-type - Completely remove a language or service from VDE
#
# This removes EVERYTHING associated with a VM type:
# - Entry from vm-types.yml
# - configs/docker/<type>/ directory
# - VM if built
# - All Docker images
# - SSH config entries (~/.ssh/config and project SSH config)
# - Env files, logs
#
# Usage: uninstall-vm-type <vm_type> [--dry-run] [--skip-confirm]
#===============================================================================

# Determine VDE root directory
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
VDE_ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Source shared library
source "$SCRIPT_DIR/lib/vde-shell-compat"
source "$SCRIPT_DIR/lib/vde-constants"
source "$SCRIPT_DIR/lib/vde-errors"
source "$SCRIPT_DIR/lib/vde-log"
source "$SCRIPT_DIR/lib/vde-core"
source "$SCRIPT_DIR/lib/vm-common"

# Initialize logging
vde_log_init 2>/dev/null || true

#===============================================================================
# Variables
#===============================================================================

DRY_RUN=false
SKIP_CONFIRM=false
VM_TYPES_FILE="$VDE_ROOT_DIR/scripts/data/vm-types.conf"

# Colors
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    NC='\033[0m'
else
    RED=''
    GREEN=''
    YELLOW=''
    BLUE=''
    NC=''
fi

#===============================================================================
# Helper Functions
#===============================================================================

print_warning() {
    echo "${YELLOW}WARNING: $1${NC}"
}

print_error() {
    echo "${RED}ERROR: $1${NC}"
}

print_success() {
    echo "${GREEN}SUCCESS: $1${NC}"
}

print_info() {
    echo "${BLUE}INFO: $1${NC}"
}

print_dry_run() {
    echo ""
    echo "============================================================================="
    echo "${YELLOW}DRY RUN MODE${NC} - No changes will be made"
    echo "============================================================================="
    echo ""
}

ask_yes_no() {
    local prompt="$1"
    local default="${2:-n}"

    if [[ "$SKIP_CONFIRM" = "true" ]]; then
        return 0
    fi

    local yn
    if [[ "$default" = "y" ]]; then
        prompt="$prompt [Y/n]"
    else
        prompt="$prompt [y/N]"
    fi

    while true; do
        echo -n "$prompt "
        read -r yn
        yn=${yn:-$default}

        case "$yn" in
            [Yy]|[Yy][Ee][Ss]) return 0 ;;
            [Nn]|[Nn][Oo]) return 1 ;;
            *) echo "Please answer yes or no." ;;
        esac
    done
}

#===============================================================================
# VM Type Removal Functions
#===============================================================================

# Remove entry from vm-types.yml
remove_vm_type_entry() {
    local vm_type="$1"

    if [[ ! -f "$VM_TYPES_FILE" ]]; then
        print_info "No vm-types.conf file found"
        return 0
    fi

    local temp_file="${VM_TYPES_FILE}.tmp"

    if [[ "$DRY_RUN" = "true" ]]; then
        print_info "[DRY RUN] Would remove entry for '$vm_type' from vm-types.conf"
        grep -E "^(lang|service)\|${vm_type}\|" "$VM_TYPES_FILE" 2>/dev/null || print_info "[DRY RUN]   (no entry found)"
        return 0
    fi

    # Remove lines matching the VM type (format: lang|rust|... or service|postgres|...)
    grep -v -E "^(lang|service)\|${vm_type}\|" "$VM_TYPES_FILE" > "$temp_file" 2>/dev/null || true

    if ! cmp -s "$VM_TYPES_FILE" "$temp_file" 2>/dev/null; then
        mv "$temp_file" "$VM_TYPES_FILE"
        print_success "Removed '$vm_type' from vm-types.conf"

        # Invalidate the cache so it gets regenerated
        rm -f "$VDE_CACHE_DIR/vm-types.cache" 2>/dev/null || true
    else
        rm -f "$temp_file"
        print_info "No entry found for '$vm_type' in vm-types.conf"
    fi
}

# Remove docker config directory
remove_docker_config() {
    local vm_type="$1"
    local config_dir="$VDE_ROOT_DIR/configs/docker/${vm_type}"

    if [[ ! -d "$config_dir" ]]; then
        print_info "No config directory found: $config_dir"
        return 0
    fi

    if [[ "$DRY_RUN" = "true" ]]; then
        print_info "[DRY RUN] Would remove directory: $config_dir"
        return 0
    fi

    print_info "Removing config directory: $config_dir"
    rm -rf "$config_dir"
    print_success "Removed: $config_dir"
}

# Stop and remove VM if running
remove_vm() {
    local vm_type="$1"

    if vm_exists "$vm_type" 2>/dev/null; then
        if vm_is_running "$vm_type" 2>/dev/null; then
            if [[ "$DRY_RUN" = "true" ]]; then
                print_info "[DRY RUN] Would stop VM: $vm_type"
            else
                print_info "Stopping VM: $vm_type"
                shutdown_vm "$vm_type" 2>/dev/null || true
            fi
        fi

        local compose_file="$VDE_ROOT_DIR/configs/docker/${vm_type}/docker-compose.yml"
        if [[ -f "$compose_file" ]]; then
            if [[ "$DRY_RUN" = "true" ]]; then
                print_info "[DRY RUN] Would remove docker-compose.yml: $compose_file"
            else
                rm -f "$compose_file"
                print_success "Removed: $compose_file"
            fi
        fi
    else
        print_info "VM '$vm_type' not built, skipping VM removal"
    fi
}

# Remove Docker images for the VM type
remove_docker_images() {
    local vm_type="$1"
    local image_prefix="dev-${vm_type}"

    local images
    images=$(docker images --format "{{.Repository}}:{{.Tag}}" 2>/dev/null | grep "^${image_prefix}" || echo "")

    if [[ -z "$images" ]]; then
        print_info "No Docker images found for '$vm_type'"
        return 0
    fi

    local image_count=$(echo "$images" | wc -l | tr -d ' ')

    if [[ "$DRY_RUN" = "true" ]]; then
        print_info "[DRY RUN] Would remove $image_count Docker image(s) for '$vm_type':"
        echo "$images" | while read -r image; do
            [[ -n "$image" ]] && print_info "[DRY RUN]   - $image"
        done
        return 0
    fi

    print_info "Removing $image_count Docker image(s) for '$vm_type'..."
    echo "$images" | while read -r image; do
        [[ -n "$image" ]] && docker rmi -f "$image" >/dev/null 2>&1 || true
    done
    print_success "Removed Docker images for '$vm_type'"
}

# Remove SSH config entries
remove_ssh_entries() {
    local vm_type="$1"

    # Get VM category to determine SSH hostname
    local vm_category
    vm_category=$(get_vm_info type "$vm_type" 2>/dev/null || echo "")

    local ssh_hosts=()

    if [[ "$vm_category" == "lang" ]]; then
        ssh_hosts=("${vm_type}-dev")
    elif [[ "$vm_category" == "service" ]]; then
        ssh_hosts=("$vm_type")
    else
        # Default: treat as language
        ssh_hosts=("${vm_type}-dev")
    fi

    if [[ "$DRY_RUN" = "true" ]]; then
        print_info "[DRY RUN] Would remove SSH config entries for: ${ssh_hosts[*]}"
        return 0
    fi

    local ssh_config="${HOME}/.ssh/config"
    if [[ -f "$ssh_config" ]]; then
        for host in "${ssh_hosts[@]}"; do
            print_info "Removing SSH config entry for: $host"
            remove_ssh_config_entry "$host" 2>/dev/null || true
        done
        print_success "Removed SSH config entries"
    fi
}

# Remove env files
remove_env_files() {
    local vm_type="$1"
    local env_file="$VDE_ROOT_DIR/env-files/${vm_type}.env"

    if [[ ! -f "$env_file" ]]; then
        print_info "No env file found: $env_file"
        return 0
    fi

    if [[ "$DRY_RUN" = "true" ]]; then
        print_info "[DRY RUN] Would remove env file: $env_file"
        return 0
    fi

    rm -f "$env_file"
    print_success "Removed: $env_file"
}

# Remove logs
remove_logs() {
    local vm_type="$1"
    local log_dir="$VDE_ROOT_DIR/logs/${vm_type}"

    if [[ ! -d "$log_dir" ]]; then
        print_info "No logs directory found: $log_dir"
        return 0
    fi

    if [[ "$DRY_RUN" = "true" ]]; then
        print_info "[DRY RUN] Would remove logs directory: $log_dir"
        return 0
    fi

    rm -rf "$log_dir"
    print_success "Removed: $log_dir"
}

#===============================================================================
# Main
#===============================================================================

main() {
    # Handle --help first
    if [[ "$1" == "--help" ]] || [[ "$1" == "-h" ]]; then
        echo "Usage: $0 <vm_type> [options]"
        echo ""
        echo "Completely remove a language or service from VDE."
        echo ""
        echo "This will remove:"
        echo "  - Entry from vm-types.conf"
        echo "  - configs/docker/<vm_type>/ directory"
        echo "  - VM if it's built"
        echo "  - All Docker images"
        echo "  - SSH config entries"
        echo "  - Env files and logs"
        echo ""
        echo "Options:"
        echo "  --dry-run         Show what would be done without making changes"
        echo "  --skip-confirm    Skip confirmation prompts (dangerous!)"
        echo "  -h, --help        Show this help message"
        echo ""
        exit 0
    fi

    # Parse arguments
    if [[ $# -eq 0 ]]; then
        echo "Usage: $0 <vm_type> [--dry-run] [--skip-confirm]"
        echo ""
        echo "Completely remove a language or service from VDE."
        echo ""
        echo "This will remove:"
        echo "  - Entry from vm-types.conf"
        echo "  - configs/docker/<vm_type>/ directory"
        echo "  - VM if built"
        echo "  - All Docker images"
        echo "  - SSH config entries"
        echo "  - Env files and logs"
        echo ""
        echo "Options:"
        echo "  --dry-run         Show what would be done without making changes"
        echo "  --skip-confirm    Skip confirmation prompts (dangerous!)"
        echo ""
        exit 1
    fi

    local VM_TYPE="$1"
    shift

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --dry-run)
                DRY_RUN=true
                shift
                ;;
            --skip-confirm)
                SKIP_CONFIRM=true
                shift
                ;;
            *)
                echo "Unknown option: $1"
                exit 1
                ;;
        esac
    done

    #===========================================================================
    # Validation
    #===========================================================================

    # Ensure VM types are loaded
    load_vm_types 2>/dev/null || true

    # Check if VM type exists by checking if it's in the cache
    if ! grep -q "^VM_TYPE:${VM_TYPE}=" "$VDE_CACHE_DIR/vm-types.cache" 2>/dev/null; then
        print_error "VM type '$VM_TYPE' not found"
        echo ""
        echo "Available VM types:"
        # Get all VM types from the cache
        if [[ -f "$VDE_CACHE_DIR/vm-types.cache" ]]; then
            grep "^VM_TYPE:" "$VDE_CACHE_DIR/vm-types.cache" | sed 's/^VM_TYPE:/  /' | sed 's/=.*//' | sort
        fi
        exit 1
    fi

    #===========================================================================
    # Warning and Confirmation
    #===========================================================================

    echo ""
    echo "============================================================================="
    echo "                COMPLETE REMOVAL OF VM TYPE: $VM_TYPE"
    echo "============================================================================="
    echo ""
    print_warning "This will COMPLETELY remove '$VM_TYPE' from VDE!"
    echo ""
    print_warning "This action is NOT reversible (unless you re-add it with add-vm-type)"
    echo ""
    echo "The following will be removed:"
    echo "  - Entry from vm-types.conf"
    echo "  - configs/docker/${VM_TYPE}/ directory"
    echo "  - VM if it's built"
    echo "  - All Docker images (dev-${VM_TYPE}:*)"
    echo "  - SSH config entries"
    echo "  - Env files and logs"
    echo ""

    if [[ "$DRY_RUN" = "true" ]]; then
        print_dry_run
    fi

    # Mandatory confirmation
    if ! ask_yes_no "Are you sure you want to completely remove '$VM_TYPE' from VDE?" "n"; then
        print_info "Uninstall cancelled"
        exit 0
    fi

    # Second confirmation for safety
    if [[ "$SKIP_CONFIRM" != "true" ]]; then
        if ! ask_yes_no "This is your last chance - are you REALLY sure?" "n"; then
            print_info "Uninstall cancelled"
            exit 0
        fi
    fi

    #===========================================================================
    # Execute Removal
    #===========================================================================

    echo ""
    echo "============================================================================="
    if [[ "$DRY_RUN" = "true" ]]; then
        print_info "DRY RUN - Showing what would be done..."
    else
        print_info "Removing '$VM_TYPE' from VDE..."
    fi
    echo "============================================================================="
    echo ""

    # Remove in safe order
    remove_vm "$VM_TYPE"
    remove_docker_images "$VM_TYPE"
    remove_ssh_entries "$VM_TYPE"
    remove_env_files "$VM_TYPE"
    remove_logs "$VM_TYPE"
    remove_docker_config "$VM_TYPE"
    remove_vm_type_entry "$VM_TYPE"

    #===========================================================================
    # Final Message
    #===========================================================================

    echo ""
    echo "============================================================================="
    if [[ "$DRY_RUN" = "true" ]]; then
        print_success "DRY RUN COMPLETE - No changes were made"
    else
        print_success "VM type '$VM_TYPE' has been completely removed from VDE"
    fi
    echo "============================================================================="
    echo ""

    if [[ "$DRY_RUN" = "true" ]]; then
        print_info "To run the actual uninstall, run:"
        echo "  vde uninstall $VM_TYPE"
        echo "  or"
        echo "  ./scripts/uninstall-vm-type $VM_TYPE"
        echo ""
    else
        print_info "To re-add this VM type, use:"
        echo "  ./scripts/add-vm-type $VM_TYPE"
        echo ""
    fi
}

main "$@"
