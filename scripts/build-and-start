#!/usr/bin/env zsh
#===============================================================================
# build-and-start - Initialize VDE infrastructure and start all VMs
#
# First-time setup script for users who have already installed Docker Desktop and git
#
# This script will:
# • Create the VDE directory structure
# • Set up SSH keys and agent for VM-to-VM communication
# • Generate missing docker-compose.yml files for all VM types
# • Initialize Docker network
# • Start your VMs
#===============================================================================

set -e

# Source shared library
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$SCRIPT_DIR/lib/vde-shell-compat"
source "$SCRIPT_DIR/lib/vde-constants"
source "$SCRIPT_DIR/lib/vde-errors"
source "$SCRIPT_DIR/lib/vde-log"
source "$SCRIPT_DIR/lib/vde-core"
source "$SCRIPT_DIR/lib/vm-common"

# Initialize logging
vde_log_init 2>/dev/null || true

# Parse flags
REBUILD=false
NOCACHE=false

for arg in "$@"; do
    case $arg in
        --rebuild)
            REBUILD=true
            ;;
        --no-cache)
            NOCACHE=true
            ;;
        *)
            echo "Unknown option: $arg"
            exit 1
            ;;
    esac
done

#===============================================================================
# Welcome Message
#===============================================================================

echo ""
echo "╔════════════════════════════════════════════════════════════╗"
echo "║          VDE First-Time Setup                             ║"
echo "╚════════════════════════════════════════════════════════════╝"
echo ""
echo "This script will:"
echo "  • Create the VDE directory structure"
echo "  • Generate all missing docker-compose.yml files"
echo "  • Set up SSH keys and agent for VM-to-VM communication"
echo "  • Initialize Docker network"
echo "  • Set proper file permissions"
echo ""

#===============================================================================
# Step 1: Prerequisites Check
#===============================================================================

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Step 1: Checking Prerequisites"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Check Docker
if ! command -v docker &>/dev/null; then
    log_error "Docker is not installed or not in PATH"
    echo "  Please install Docker Desktop first:"
    echo "  https://www.docker.com/products/docker-desktop/"
    exit 1
fi

# Check if Docker daemon is running
if ! docker info &>/dev/null; then
    log_error "Docker daemon is not running"
    echo "  Please start Docker Desktop and try again"
    exit 1
fi

log_success "✓ Docker is installed and running"

# Check git
if ! command -v git &>/dev/null; then
    log_error "git is not installed or not in PATH"
    echo "  Please install git first:"
    echo "  https://git-scm.com/downloads"
    exit 1
fi

log_success "✓ git is installed"

echo ""

#===============================================================================
# Step 2: Create VDE Directory Structure
#===============================================================================

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Step 2: Creating VDE Directory Structure"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Core directories
mkdir -p "$CONFIGS_DIR"
mkdir -p "$TEMPLATES_DIR"
mkdir -p "$VDE_ROOT_DIR/projects"
mkdir -p "$VDE_ROOT_DIR/data"
mkdir -p "$VDE_ROOT_DIR/logs"
mkdir -p "$VDE_ROOT_DIR/env-files"
mkdir -p "$VDE_ROOT_DIR/public-ssh-keys"
mkdir -p "$VDE_ROOT_DIR/.cache"
mkdir -p "$VDE_ROOT_DIR/.locks"
mkdir -p "$VDE_ROOT_DIR/.locks/ports"

log_success "✓ Core directories created"

echo ""

#===============================================================================
# Step 3: Generate Missing Docker Configs
#===============================================================================

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Step 3: Generating Missing Docker Configurations"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Run the generate-all-configs script
if "$SCRIPT_DIR/generate-all-configs" 2>/dev/null; then
    log_success "✓ Docker configurations generated"
else
    log_error "✗ Failed to generate configurations"
    exit 1
fi

echo ""

#===============================================================================
# Step 4: Set Up SSH Keys and Agent
#===============================================================================

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Step 4: Setting Up SSH Keys and Agent"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "This enables secure VM-to-VM communication without exposing"
echo "your private keys to containers."
echo ""

# Run the SSH setup script
if "$SCRIPT_DIR/ssh-agent-setup" --init 2>/dev/null; then
    log_success "✓ SSH environment configured"
else
    log_error "✗ SSH setup failed"
    echo "  You can run this manually later: ./scripts/ssh-agent-setup --init"
fi

echo ""

#===============================================================================
# Step 5: Initialize Docker Network
#===============================================================================

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Step 5: Initializing Docker Network"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

if ! docker network inspect vde-network &>/dev/null; then
    docker network create vde-network >/dev/null 2>&1 || \
    docker network create dev-net >/dev/null 2>&1 || true
fi

log_success "✓ Docker network ready"

echo ""

#===============================================================================
# Step 6: Set File Permissions
#===============================================================================

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Step 6: Setting File Permissions"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Set proper permissions on directories
chmod 700 "$VDE_ROOT_DIR/public-ssh-keys" 2>/dev/null || true
chmod 755 "$VDE_ROOT_DIR/.cache" 2>/dev/null || true
chmod 755 "$VDE_ROOT_DIR/.locks" 2>/dev/null || true
chmod 755 "$VDE_ROOT_DIR/.locks/ports" 2>/dev/null || true

# Ensure scripts are executable
find "$SCRIPT_DIR" -type f -name "*.sh" -exec chmod +x {} \; 2>/dev/null || true

log_success "✓ File permissions set"

echo ""
echo "╔════════════════════════════════════════════════════════════╗"
echo "║          VDE Setup Complete!                               ║"
echo "╚════════════════════════════════════════════════════════════╝"
echo ""
echo "Your VDE environment is ready!"
echo ""
echo "Available VM types (all configured):"
echo ""
echo "Languages:"
echo "  c, cpp, asm, python, rust, js, csharp, ruby, go"
echo "  java, kotlin, swift, php, scala, r, lua, flutter, elixir, haskell"
echo ""
echo "Services:"
echo "  postgres, redis, mongodb, nginx, couchdb, mysql, rabbitmq"
echo ""
echo "Quick Start Commands:"
echo ""
echo "  # Create and start a VM"
echo "  ./scripts/create-virtual-for python"
echo "  ./scripts/start-virtual python"
echo ""
echo "  # Or create and start in one command"
echo "  ./scripts/create-and-start python"
echo ""
echo "  # Create and start multiple VMs"
echo "  ./scripts/create-and-start python rust go"
echo ""
echo "  # See all available VM types"
echo "  ./scripts/list-vms"
echo ""
echo "  # View SSH status"
echo "  ./scripts/ssh-agent-setup"
echo ""
echo "Documentation:"
echo "  docs/USER_GUIDE.md           # Comprehensive user guide"
echo "  docs/ARCHITECTURE.md         # System architecture"
echo ""
echo "Happy coding!"
echo ""
