#!/usr/bin/env zsh
# list-vms - List all predefined VM types
# Enhanced with --name-only flag and improved formatting

# Reset all zsh options to defaults to avoid local var printing issues
emulate zsh

# Source shared library
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$SCRIPT_DIR/lib/vm-common"

# Source UX libraries
if [[ -f "$SCRIPT_DIR/lib/vde-naming" ]]; then
    source "$SCRIPT_DIR/lib/vde-naming"
fi

# Parse arguments
LIST_TYPE=""
FILTER=""
NAME_ONLY=false
SHOW_CREATED=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --lang|--languages)
            LIST_TYPE="lang"
            shift
            ;;
        --svc|--services)
            LIST_TYPE="service"
            shift
            ;;
        --name-only)
            NAME_ONLY=true
            shift
            ;;
        -a|--all)
            SHOW_CREATED=true
            shift
            ;;
        --help|-h)
            echo "Usage: list-vms [OPTIONS] [filter]"
            echo ""
            echo "List all predefined VM types (languages and services)."
            echo ""
            echo "Options:"
            echo "  --lang, --languages    List only language VMs"
            echo "  --svc, --services      List only service VMs"
            echo "  --name-only            Show only VM names (hostnames)"
            echo "  -a, --all              Show all VMs including created status"
            echo "  --help, -h             Show this help message"
            echo ""
            echo "Arguments:"
            echo "  filter                 Optional text filter (searches name, aliases, display)"
            echo ""
            echo "Examples:"
            echo "  list-vms                    # List all VMs"
            echo "  list-vms --lang             # List only language VMs"
            echo "  list-vms --svc              # List only service VMs"
            echo "  list-vms --name-only        # Show only names/hostnames"
            echo "  list-vms python             # Search for 'python'"
            echo "  list-vms --lang script      # Search for script in languages"
            exit 0
            ;;
        *)
            FILTER="$1"
            shift
            ;;
    esac
done

# Function to display VM info
display_vm() {
    local name=$1
    local type=$2
    local display=$3
    local vm_aliases=$4

    # Apply filter if specified
    if [[ -n "$FILTER" ]]; then
        if [[ ! "$name" =~ "$FILTER" ]] && [[ ! "$display" =~ "$FILTER" ]] && [[ ! "$vm_aliases" =~ "$FILTER" ]]; then
            return
        fi
    fi

    if [[ "$NAME_ONLY" == "true" ]]; then
        # Show hostname (for language VMs: name-dev, for services: name)
        local hostname
        hostname=$(vde_get_hostname "$name")
        printf "%s\n" "$hostname"
    else
        local marker=""
        local status_color=""

        if vm_exists "$name"; then
            marker=" [CREATED]"
            if [[ "$SHOW_CREATED" == "true" ]]; then
                # Get running status
                local compose_file="$CONFIGS_DIR/$name/docker-compose.yml"
                if [[ -f "$compose_file" ]]; then
                    local running
                    running=$(docker-compose -f "$compose_file" ps --services --filter "status=running" 2>/dev/null | wc -l)
                    if [[ "$running" -gt 0 ]]; then
                        marker=" [RUNNING: $running]"
                    else
                        marker=" [STOPPED]"
                    fi
                fi
            fi
        fi

        printf "  %-20s %s%s\n" "$name" "$display" "$marker"

        if [[ -n "$vm_aliases" ]]; then
            printf "    Aliases: %s\n" "$vm_aliases"
        fi

        if [[ "$type" == "service" ]]; then
            local svc_port
            svc_port=$(_assoc_get "VM_SVC_PORT" "$name" 2>/dev/null) || svc_port=""
            if [[ -n "$svc_port" ]]; then
                printf "    Service Port: %s\n" "$svc_port"
            fi
        fi
    fi
}

# Header (only if not --name-only)
if [[ "$NAME_ONLY" == "false" ]]; then
    echo "Predefined VM Types:"
    echo ""
fi

if [[ "$LIST_TYPE" == "lang" ]]; then
    if [[ "$NAME_ONLY" == "false" ]]; then
        echo "Language VMs:"
    fi
    for name in $(get_lang_vms); do
        local vm_display=$(_assoc_get "VM_DISPLAY" "$name" 2>/dev/null) || vm_display="$name"
        local vm_aliases=$(_assoc_get "VM_ALIASES" "$name" 2>/dev/null) || vm_aliases=""
        display_vm "$name" "lang" "$vm_display" "$vm_aliases"
    done
elif [[ "$LIST_TYPE" == "service" ]]; then
    if [[ "$NAME_ONLY" == "false" ]]; then
        echo "Service VMs:"
    fi
    for name in $(get_service_vms); do
        local vm_display=$(_assoc_get "VM_DISPLAY" "$name" 2>/dev/null) || vm_display="$name"
        local vm_aliases=$(_assoc_get "VM_ALIASES" "$name" 2>/dev/null) || vm_aliases=""
        display_vm "$name" "service" "$vm_display" "$vm_aliases"
    done
else
    if [[ "$NAME_ONLY" == "false" ]]; then
        echo "Language VMs:"
    fi
    for name in $(get_lang_vms); do
        local vm_display=$(_assoc_get "VM_DISPLAY" "$name" 2>/dev/null) || vm_display="$name"
        local vm_aliases=$(_assoc_get "VM_ALIASES" "$name" 2>/dev/null) || vm_aliases=""
        display_vm "$name" "lang" "$vm_display" "$vm_aliases"
    done

    if [[ "$NAME_ONLY" == "false" ]]; then
        echo ""
        echo "Service VMs:"
    fi
    for name in $(get_service_vms); do
        local vm_display=$(_assoc_get "VM_DISPLAY" "$name" 2>/dev/null) || vm_display="$name"
        local vm_aliases=$(_assoc_get "VM_ALIASES" "$name" 2>/dev/null) || vm_aliases=""
        display_vm "$name" "service" "$vm_display" "$vm_aliases"
    done
fi

if [[ "$NAME_ONLY" == "false" ]]; then
    echo ""
    echo "To create a VM, run: create-virtual-for <name>"
    echo "To add a new VM type, run: add-vm-type <name> \"<install_cmd>\""
fi
