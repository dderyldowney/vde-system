#!/usr/bin/env zsh
# remove-virtual - Stop a VM and clean up its SSH references
# Stops the VM, removes SSH config entry, preserves docker-compose.yml for easy recreation

set -e

# Source shared library
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$SCRIPT_DIR/lib/vm-common"

# Source UX libraries (optional - for enhanced UX)
if [[ -f "$SCRIPT_DIR/lib/vde-progress" ]]; then
    source "$SCRIPT_DIR/lib/vde-progress"
fi
if [[ -f "$SCRIPT_DIR/lib/vde-errors" ]]; then
    source "$SCRIPT_DIR/lib/vde-errors"
fi
if [[ -f "$SCRIPT_DIR/lib/vde-naming" ]]; then
    source "$SCRIPT_DIR/lib/vde-naming"
fi

# Parse arguments
if [[ $# -eq 0 ]]; then
    echo "Usage: $0 <vm_name>"
    echo ""
    echo "Stop a VM and clean up its SSH references."
    echo ""
    echo "This will:"
    echo "  - Stop the VM if running"
    echo "  - Remove SSH config entry from ~/.ssh/config"
    echo "  - Clean up known_hosts entries"
    echo "  - Keep docker-compose.yml (for easy VM recreation)"
    echo "  - Keep projects directory (your code is safe!)"
    echo ""
    echo "To recreate the VM later:"
    echo "  ./scripts/start-virtual <vm_name>"
    echo ""
    show_known_vms
    exit 1
fi

if [[ "$VM_NAME" == "all" ]]; then
    # Delete all VMs but keep images, configs, and project
    log_info "Deleting all VMs..."

    # Get all VMs
    local vms
    vms=$(get_all_vms)

    if [[ -z "$vms" ]]; then
        log_info "No VMs found to delete"
        exit 0
    fi

    local vm
    local deleted_count=0

    for vm in $vms; do
        if [[ -n "$vm" ]]; then
            # Recursively call remove-virtual for each VM
            remove-virtual "$vm" || log_warning "Failed to remove VM: $vm"
            ((deleted_count++))
        fi
    done

    if [[ $deleted_count -gt 0 ]]; then
        log_success "Deleted $deleted_count VM(s)"
    else
        log_info "All VMs already deleted"
    fi

    exit 0
fi

VM_NAME="$1"

# Resolve VM name if it's an alias
RESOLVED_VM=$(resolve_vm_name "$VM_NAME" 2>/dev/null) || true
if [[ -n "$RESOLVED_VM" ]]; then
    VM_NAME="$RESOLVED_VM"
fi

# Get compose file path
COMPOSE_FILE="$CONFIGS_DIR/$VM_NAME/docker-compose.yml"

# Check if VM exists
if [[ ! -f "$COMPOSE_FILE" ]]; then
    log_error "VM '$VM_NAME' not found (no docker-compose.yml at $VM_NAME)"
    exit 1
fi

log_info "Removing VM: $VM_NAME"

# Get VM type to determine SSH hostname
VM_TYPE=$(get_vm_info type "$VM_NAME" 2>/dev/null) || echo "unknown"

# Stop the VM if running
if vm_is_running "$VM_NAME" 2>/dev/null; then
    log_info "Stopping VM..."
    stop_vm "$VM_NAME"
fi

# Remove SSH known_hosts entries (before removing config, so we can still get port)
if [[ -z "$VDE_TEST_MODE" ]]; then
    log_info "Cleaning up SSH known_hosts..."
    remove_known_hosts_entry "$VM_NAME" 2>/dev/null || true
fi

# NOTE: docker-compose.yml is PRESERVED - user can easily recreate VM
# The compose file is generated once and stays unless manually deleted

# Remove env file (can be regenerated, safe to delete)
ENV_FILE="$VDE_ROOT_DIR/env-files/$VM_NAME.env"
if [[ -f "$ENV_FILE" ]]; then
    rm -f "$ENV_FILE"
    log_success "Deleted: $ENV_FILE"
fi

# Remove logs directory if empty
LOGS_DIR="$VDE_ROOT_DIR/logs/$VM_NAME"
if [[ -d "$LOGS_DIR" ]]; then
    rmdir "$LOGS_DIR" 2>/dev/null && log_success "Removed empty logs directory" || true
fi

# Remove SSH config entry (skip in test mode)
if [[ -z "$VDE_TEST_MODE" ]]; then
    log_info "Removing SSH config entry..."

    # Determine SSH hostname based on VM type
    local ssh_host
    if [[ "$VM_TYPE" == "lang" ]]; then
        ssh_host="${VM_NAME}-dev"
    elif [[ "$VM_TYPE" == "service" ]]; then
        ssh_host="$VM_NAME"
        # Also remove common aliases for services
        remove_ssh_config_entry "$ssh_host" 2>/dev/null || true
    else
        ssh_host="${VM_NAME}-dev"
    fi

    # Remove from SSH config
    if [[ -f "$HOME/.ssh/config" ]]; then
        # Create backup
        cp "$HOME/.ssh/config" "$HOME/.ssh/config.backup"

        # Remove the entry
        remove_ssh_config_entry "$ssh_host" 2>/dev/null || true

        log_success "SSH config entry removed for $ssh_host"
    fi
else
    log_info "Skipping SSH config removal (test mode)"
fi

log_success "VM '$VM_NAME' removed successfully!"
echo ""
echo "Note: Your projects directory at $VDE_ROOT_DIR/projects/$VM_NAME was preserved."
