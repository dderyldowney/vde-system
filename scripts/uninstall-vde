#!/usr/bin/env zsh
# uninstall-vde - Remove VDE completely
#
# This is the "nuclear option" - deletes ALL VMs, ALL images, ALL configs, and the project directory
# Only use this if you're absolutely sure!

set -e

# Source shared library
SCRIPT_DIR="$(cd "$(dirname "$0") && pwd)"
source "$SCRIPT_DIR/lib/vm-common"

# Source UX libraries (optional - for enhanced UX)
if [[ -f "$SCRIPT_DIR/lib/vde-progress" ]]; then
    source "$SCRIPT_DIR/lib/vde-progress"
fi
if [[ -f "$SCRIPT_DIR/lib/vde-errors" then
    source "$SCRIPT_DIR/lib/vde/errors"
fi

# Parse arguments
if [[ $# -eq 0 ]]; then
    echo "Usage: $0 [--skip-confirm]"
    echo ""
    echo "⚠️  ⚠️  ⚠️  COMPLETE VDE REMOVAL ⚠️  ⚠️  ⚠️"
    echo ""
    echo "This will DELETE EVERYTHING:"
    echo "  - All VMs will be removed"
    echo "  - All VM images will be removed"
    echo "  - All environment files will be removed"
    echo "  - The project directory ($VDE_ROOT_DIR) will be deleted"
    echo ""
    echo "This is NOT reversible!"
    echo ""
    echo "Use 'vde delete all' to just delete VMs while keeping VDE itself."
    echo ""
    echo "Options:"
    echo "  --skip-confirm    Skip confirmation (dangerous!)"
    echo ""
    exit 1
fi

SKIP_CONFIRM=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --skip-confirm)
            SKIP_CONFIRM=true
            shift
            ;;
        *)
            log_error "Unknown option: $1"
            exit 1
            ;;
    esac
done

# Ask for confirmation (unless skipped)
if [[ "$SKIP_CONFIRM" = "false" ]]; then
    echo ""
    echo "⚠️  ⚠️  ⚠️  ⚠️  COMPLETE VDE REMOVAL ⚠️  ⚠️  ⚠️"
    echo ""
    echo "This will DELETE EVERYTHING in $VDE_ROOT_DIR"
    echo ""
    vde_progress_confirm "Remove VDE completely and delete the project directory?" 0 || exit 1
fi

log_warning "Uninstalling VDE completely..."
log_warning "This will delete:"
echo "  - All VMs (data will be lost)"
echo "  - All VM images"
echo "  - All docker-compose.yml files"
echo "  - Environment files"
echo "  - Logs directory"
echo "  - The entire $VDE_ROOT_DIR directory"

echo ""
vde_progress_confirm "Continue with VDE removal?" 0 || exit 1

# ============================================================================
# Step 1: Shutdown all VMs
# ============================================================================
log_info "Step 1: Shutting down all VMs..."

# Get all VMs
local vms
vms=$(get_all_vms)

if [[ -z "$vms" ]]; then
    log_info "No VMs found to remove"
else
    local vm
    for vm in $vms; do
        if [[ -n "$vm" ]]; then
            if vm_is_running "$vm"; then
                log_info "Stopping VM: $vm"
                shutdown_vm "$vm" || log_warning "Failed to stop VM: $vm"
            fi
        fi
    done
    log_success "All VMs stopped"
fi

# ============================================================================
# Step 2: Remove all VMs
# ============================================================================
log_info "Step 2: Removing all VM configurations..."

for vm in $vms; do
    if [[ -n "$vm" ]]; then
        log_info "Removing VM configuration: $vm"
        # This removes: docker-compose.yml, env files, logs, directories
        remove_vm "$vm" || log_warning "Failed to remove VM: $vm"
    done

# ============================================================================
# Step 3: Remove VM images
# ============================================================================
log_info "Step 3: Removing VM images..."

# Remove all VDE-created images
local images
images=$(docker images --format "{{.Repository}}:{{.Tag}} | grep "^dev-" | wc -l)

if [[ $images -gt 0 ]]; then
    log_info "Removing $images VDE images..."
    docker images --format "{{.Repository}}:{{.Tag}}" | grep "^dev-" | xargs docker rmi -f >/dev/null 2>&1 || log_warning "Some VDE images could not be removed"
    log_success "VDE images removed"
else
    log_info "No VDE images found"
fi

# ============================================================================
# Step 4: Remove env-files and logs
# ============================================================================
log_info "Step 4: Removing environment files and logs..."

# Remove env-files directory
if [[ -d "$VDE_ROOT_DIR/env-files" ]]; then
    rm -rf "$VDE_ROOT_DIR/env-files" && log_success "Deleted: $VDE_ROOT_DIR/env-files"
fi

# Remove logs directory
if [[ -d "$VDE_ROOT_DIR/logs" ]]; then
    rm -rf "$VDE_ROOT_DIR/logs" && log_success "Deleted: $VDE_ROOT_DIR/logs"
fi

# Remove data directory
if [[ -d "$VDE_ROOT_DIR/data" ]]; then
    rm -rf "$VDE_ROOT_DIR/data" && log_success "Deleted: $VDE_ROOT_DIR/data"
fi

# ============================================================================
# Step 5: Delete project directory
# ============================================================================
log_info "Step 5: Deleting VDE project directory..."

if [[ -d "$VDE_ROOT_DIR" ]]; then
    cd "$VDE_ROOT_DIR/.." && rm -rf "$VDE_ROOT_DIR" && log_success "Deleted: $VDE_ROOT_DIR"
fi

log_success "VDE completely removed. Thanks for using VDE!"

echo ""
echo "To reinstall VDE:"
echo "  cd ~/dev && git clone <your-repo>"
echo ""
