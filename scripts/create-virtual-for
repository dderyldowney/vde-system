#!/usr/bin/env zsh
# create-virtual-for - Create a new VM with predefined configuration
# Enhanced with progress indicators and improved error messages

set -e

# Source shared library
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$SCRIPT_DIR/lib/vm-common"

# Source UX libraries (optional - for enhanced UX)
if [[ -f "$SCRIPT_DIR/lib/vde-progress" ]]; then
    source "$SCRIPT_DIR/lib/vde-progress"
fi
if [[ -f "$SCRIPT_DIR/lib/vde-errors" ]]; then
    source "$SCRIPT_DIR/lib/vde-errors"
fi
if [[ -f "$SCRIPT_DIR/lib/vde-naming" ]]; then
    source "$SCRIPT_DIR/lib/vde-naming"
fi

# -----------------------
# Configuration
# -----------------------
QUIET=false
VERBOSE=false

# -----------------------
# Usage
# -----------------------
show_usage() {
    cat <<EOF
Usage: create-virtual-for [OPTIONS] <vm_name>

Create a new VM with predefined configuration.

Arguments:
  vm_name    Name of the VM (must be predefined in vm-types.conf)

Options:
  -h, --help     Show this help message
  -q, --quiet    Suppress progress indicators
  -v, --verbose  Show detailed output

Examples:
  create-virtual-for python    # Create Python language VM
  create-virtual-for postgres  # Create PostgreSQL service VM

The script will:
  1. Validate the VM name (follows naming convention)
  2. Auto-allocate SSH port (2200-2299 for languages, 2400-2499 for services)
  3. Create docker-compose.yml from template
  4. Create required directories (projects/ or data/, logs/)
  5. Create environment file (env-files/)
  6. Add SSH config entry to ~/.ssh/config

Known VMs:
$(show_known_vms)

Naming Convention:
  Language VMs: <name>-dev (e.g., python-dev, rust-dev)
  Service VMs: <name> (e.g., postgres, redis)

EOF
}

# -----------------------
# Parse Arguments
# -----------------------
while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            show_usage
            exit 0
            ;;
        -q|--quiet)
            QUIET=true
            export VDE_PROGRESS_QUIET=1
            shift
            ;;
        -v|--verbose)
            VERBOSE=true
            export VDE_ERRORS_VERBOSE=1
            shift
            ;;
        -*)
            log_error "Unknown option: $1"
            exit 1
            ;;
        *)
            break
            ;;
    esac
done

if [[ $# -eq 0 ]]; then
    show_usage
    exit 1
fi

VM_NAME="$1"

# -----------------------
# Validation
# -----------------------
vde_progress_info "Validating configuration for '$VM_NAME'..."

validate_vm_name "$VM_NAME" || exit 1

# Resolve VM name (handles aliases)
RESOLVED_NAME=$(resolve_vm_name "$VM_NAME" || true)
if [[ -z "$RESOLVED_NAME" ]]; then
    vde_error_alias_not_found "$VM_NAME"
    echo ""
    show_known_vms
    exit 1
fi

# Use resolved name
VM_NAME="$RESOLVED_NAME"

validate_vm_doesnt_exist "$VM_NAME" || {
    vde_error_container_exists "$VM_NAME"
    exit 1
}

# -----------------------
# SSH Environment
# -----------------------
ensure_ssh_environment

# -----------------------
# Get VM Configuration
# -----------------------
VM_TYPE=$(get_vm_info type "$VM_NAME")
VM_DISPLAY=$(get_vm_info display "$VM_NAME")
VM_INSTALL=$(get_vm_info install "$VM_NAME")
VM_SVC_PORT=$(get_vm_info svc_port "$VM_NAME")

if [[ -z "$VM_TYPE" ]]; then
    vde_error_vm_not_found "$VM_NAME"
    exit 1
fi

# Detect VM type if not explicitly set
if [[ -z "$VM_TYPE" ]] || [[ "$VM_TYPE" == "lang" ]]; then
    DETECTED_TYPE=$(vde_detect_vm_type_from_name "$VM_NAME")
    if [[ "$DETECTED_TYPE" == "lang" ]]; then
        vde_validate_name_or_fail "$VM_NAME" "lang"
    fi
fi

vde_progress_info "VM Type: $VM_TYPE"
vde_progress_info "Display Name: $VM_DISPLAY"

# -----------------------
# Allocate Port
# -----------------------
vde_progress_info "Allocating SSH port..."
SSH_PORT=$(find_next_available_port "$VM_TYPE")
if [[ $? -ne 0 ]]; then
    vde_error_port_in_use "all available ports"
    exit 1
fi
vde_progress_info "Allocated SSH port: $SSH_PORT"

# -----------------------
# Create Directories
# -----------------------
vde_progress_info "Creating directory structure..."
ensure_vm_directories "$VM_NAME" "$VM_TYPE"

# -----------------------
# Create Docker Compose File
# -----------------------
vde_progress_info "Creating docker-compose.yml..."

compose_file="$CONFIGS_DIR/$VM_NAME/docker-compose.yml"

if [[ "$VM_TYPE" == "lang" ]]; then
    template_file="$TEMPLATES_DIR/compose-language.yml"
else
    template_file="$TEMPLATES_DIR/compose-service.yml"
fi

if [[ ! -f "$template_file" ]]; then
    vde_error_template_not_found "$template_file"
    exit 1
fi

# Render template with progress
render_template "$template_file" \
    NAME "$VM_NAME" \
    SSH_PORT "$SSH_PORT" \
    INSTALL_CMD "$VM_INSTALL" \
    SERVICE_PORT "$VM_SVC_PORT" \
    > "$compose_file"

# Handle multiple service ports
if [[ "$VM_TYPE" == "service" ]] && [[ -n "$VM_SVC_PORT" ]]; then
    while IFS= read -r line; do
        if [[ "$line" == "  ##SERVICE_PORTS##" ]]; then
            IFS=',' read -A PORTS <<< "$VM_SVC_PORT"
            for port in "${PORTS[@]}"; do
                port=$(echo "$port" | tr -d ' ')
                echo "  - \"$port:$port\""
            done
        else
            echo "$line"
        fi
    done < "$compose_file" > "${compose_file}.tmp"
    mv "${compose_file}.tmp" "$compose_file"
else
    sed -i.bak "/##SERVICE_PORTS##/d" "$compose_file"
    rm -f "${compose_file}.bak"
fi

vde_progress_done "Created: $compose_file"

# -----------------------
# Create Environment File
# -----------------------
vde_progress_info "Creating environment file..."

env_file="$VDE_ROOT_DIR/env-files/$VM_NAME.env"

cat > "$env_file" <<EOF
# Environment variables for $VM_DISPLAY development container
SSH_PORT=$SSH_PORT
EOF

if [[ -n "$VM_SVC_PORT" ]]; then
    IFS=',' read -A PORTS <<< "$VM_SVC_PORT"
    for port in "${PORTS[@]}"; do
        port=$(echo "$port" | tr -d ' ')
        upper_name=$(echo "$VM_NAME" | tr '[:lower:]' '[:upper:]')
        echo "${upper_name}_PORT=$port" >> "$env_file"
    done
fi

vde_progress_done "Created: $env_file"

# -----------------------
# Update SSH Config
# -----------------------
# Skip SSH config modification in test mode (prevents timeouts in Docker)
if [[ -n "$VDE_TEST_MODE" ]]; then
    vde_progress_info "Skipping SSH config update (test mode)"
    ssh_host="${VM_NAME}-dev"
    if [[ "$VM_TYPE" == "service" ]]; then
        ssh_host="$VM_NAME"
    fi
else
    vde_progress_info "Updating SSH configuration..."

    if [[ "$VM_TYPE" == "lang" ]]; then
        ssh_host="${VM_NAME}-dev"
    else
        ssh_host="$VM_NAME"
    fi

    if ! merge_ssh_config_entry "$ssh_host" "$SSH_PORT" "$VM_DISPLAY"; then
        vde_error_permission_denied "~/.ssh/config"
        exit 1
    fi
fi

# -----------------------
# Summary
# -----------------------
echo ""
vde_success "VM configuration complete!"
echo ""
echo "Created files:"
echo "  - $compose_file"
echo "  - $env_file"
if [[ "$VM_TYPE" == "lang" ]]; then
    echo "  - $VDE_ROOT_DIR/projects/$VM_NAME/"
else
    echo "  - $VDE_ROOT_DIR/data/$VM_NAME/"
fi
echo "  - $VDE_ROOT_DIR/logs/$VM_NAME/"
echo ""
echo "SSH Configuration:"
echo "  - Host alias: $ssh_host"
echo "  - SSH port: $SSH_PORT"
echo "  - Connect with: ssh $ssh_host"
echo ""
echo "Next steps:"
echo "  1. Review and customize env-files/$VM_NAME.env if needed"
echo "  2. Start the VM: ./scripts/start-virtual $VM_NAME"
echo "  3. Connect: ssh $ssh_host"
echo ""
