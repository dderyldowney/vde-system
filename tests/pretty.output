Feature: VM State Awareness # features/vm-state-awareness.feature:1
  As a developer using VDE
  I want the system to be aware of VM states
  So I don't accidentally duplicate operations or cause conflicts
  Scenario: Starting an already running VM                   # features/vm-state-awareness.feature:6
    Given I have a Python VM that is already running         # features/steps/parser_steps.py:718
    When I request to "start python"                         # None
    Then I should be notified that Python is already running # None
    And the system should not start a duplicate container    # None
    And the existing container should remain unaffected      # None

  Scenario: Stopping an already stopped VM                   # features/vm-state-awareness.feature:13
    Given I have a stopped VM                                # None
    When I request to "stop postgres"                        # None
    Then I should be notified that PostgreSQL is not running # None
    And no error should occur                                # None
    And the VM should remain stopped                         # None

  Scenario: Creating an existing VM                                # features/vm-state-awareness.feature:20
    Given I already have a Go VM configured                        # features/steps/pattern_steps.py:505
    When I request to "create a Go VM"                             # None
    Then I should be notified that Go already exists               # None
    And the system should not overwrite the existing configuration # None
    And I should be asked if I want to reconfigure it              # None

  Scenario: Restarting a stopped VM               # features/vm-state-awareness.feature:27
    Given I have a stopped Rust VM                # features/steps/daily_workflow_steps.py:134
    When I request to "restart rust"              # features/steps/vm_lifecycle_steps.py:1498
    Then the system should recognize it's stopped # None
    And start the Rust VM                         # None
    And I should be informed that it was started  # None

  Scenario: Status shows mixed states              # features/vm-state-awareness.feature:34
    Given I have some running and some stopped VMs # features/steps/daily_workflow_steps.py:144
    When I request "status"                        # None
    Then I should see which VMs are running        # None
    And I should see which VMs are stopped         # None
    And the states should be clearly distinguished # None

  Scenario: Smart start of already running VMs     # features/vm-state-awareness.feature:41
    Given I have Python and PostgreSQL running     # features/steps/daily_workflow_steps.py:168
    When I request to "start python and postgres"  # None
    Then I should be told both are already running # None
    And no containers should be restarted          # None
    And the operation should complete immediately  # None

  Scenario: Smart start with mixed states              # features/vm-state-awareness.feature:48
    Given I have Python running and PostgreSQL stopped # features/steps/daily_workflow_steps.py:183
    When I request to "start python and postgres"      # None
    Then I should be told Python is already running    # None
    And PostgreSQL should be started                   # None
    And I should be informed of the mixed result       # None

  Scenario: Querying specific VM status                     # features/vm-state-awareness.feature:55
    Given I want to know about a specific VM                # features/steps/daily_workflow_steps.py:198
    When I ask "is python running?"                         # features/steps/ai_steps.py:169
    Then I should receive a clear yes/no answer             # None
    And if it's running, I should see how long it's been up # None
    And if it's stopped, I should see when it was stopped   # None

  Scenario: Preventing duplicate operations    # features/vm-state-awareness.feature:62
    Given I have a running VM                  # features/steps/vm_lifecycle_steps.py:1492
    When I try to create it again              # None
    Then the system should prevent duplication # None
    And notify me of the existing VM           # None
    And suggest using the existing one         # None

  Scenario: State persistence information  # features/vm-state-awareness.feature:69
    Given I check VM status                # None
    When I view the output                 # None
    Then I should see container uptime     # None
    And I should see the image version     # None
    And I should see the last start time   # None

  Scenario: Waiting for VM to be ready    # features/vm-state-awareness.feature:76
    Given I start a VM                    # None
    When it takes time to be ready        # None
    Then I should be informed of progress # None
    And know when it's ready to use       # None
    And not be left wondering             # None

  Scenario: Notifying about background operations  # features/vm-state-awareness.feature:83
    Given a VM is being built                      # features/steps/ssh_docker_steps.py:213
    When I check status                            # None
    Then I should see it's being built             # None
    And I should see the progress                  # None
    And I should know when it will be ready        # None

  Scenario: Conflicting operation detection         # features/vm-state-awareness.feature:90
    Given I'm rebuilding a VM                       # features/steps/cache_steps.py:130
    When I try to start it at the same time         # features/steps/cache_steps.py:159
    Then the conflict should be detected            # features/steps/cache_steps.py:283
    And I should be notified                        # features/steps/cache_steps.py:293
      ASSERT FAILED:

    And the operations should be queued or rejected # None

  Scenario: State change notifications      # features/vm-state-awareness.feature:97
    Given a VM's state changes              # features/steps/ssh_docker_steps.py:248
    When I'm monitoring the system          # None
    Then I should be notified of the change # None
    And understand what caused it           # None
    And know the new state                  # None

  Scenario: Batch operation state awareness  # features/vm-state-awareness.feature:104
    Given I request to start multiple VMs    # features/steps/cache_steps.py:123
    When some are already running            # None
    Then only the stopped VMs should start   # None
    And I should be told which were skipped  # None
    And I should see which were started      # None

  Scenario: Idempotent operations                # features/vm-state-awareness.feature:111
    Given I repeat the same command              # features/steps/vm_lifecycle_steps.py:982
    When the operation is already complete       # features/steps/vm_lifecycle_steps.py:1011
    Then the result should be the same           # features/steps/vm_lifecycle_steps.py:1021
      ASSERT FAILED: No second run recorded

    And no errors should occur                   # None
    And I should be informed it was already done # None

  Scenario: Clear state communication  # features/vm-state-awareness.feature:118
    Given any VM operation occurs      # features/steps/vm_lifecycle_steps.py:1077
    When the operation completes       # features/steps/vm_lifecycle_steps.py:1089
      ASSERT FAILED: Operation did not complete: /bin/sh: line 0: cd: /vde: No such file or directory

    Then I should see the new state    # None
    And understand what changed        # None
    And be able to verify the result   # None

