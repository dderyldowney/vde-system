name: VDE CI Test

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

env:
  VDE_ROOT_DIR: ${{ github.workspace }}

jobs:
  lint:
    name: Linting
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          wget -qO- "https://github.com/koalaman/shellcheck/releases/download/v0.9.0/shellcheck-v0.9.0.linux.x86_64.tar.xz" | tar -xJ
          sudo mv shellcheck-v0.9.0/shellcheck /usr/bin/
          shellcheck --version

      - name: Run shellcheck on scripts
        run: |
          echo "Running shellcheck on all shell scripts..."
          find scripts -name "*.sh" -type f -exec shellcheck -x {} + || true

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh

      - name: Source libraries and test
        run: |
          source scripts/lib/vm-common
          echo "Testing vm-common library..."
          PYTHON_TYPE=$(get_vm_info type "python")
          if [[ "$PYTHON_TYPE" == "lang" ]]; then
            echo "✓ python type check passed"
          else
            echo "✗ python type check failed"
            exit 1
          fi
